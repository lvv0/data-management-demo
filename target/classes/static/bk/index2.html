<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量数据提交与分页展示</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        .highlight {
            background-color: yellow;
        }
    </style>
</head>
<body>

<h1>批量数据提交与分页展示</h1>

<!-- 文件上传表单 -->
<form id="uploadForm" enctype="multipart/form-data">
    <input type="file" id="fileInput" name="file" accept=".xls,.xlsx">
    <button type="button" onclick="submitData()">提交</button>
</form>

<!-- 下载按钮 -->
<a id="downloadLink" style="display:none;" download="InvalidData.xlsx">下载不符合规则的数据</a>

<!-- 分页数据表 -->
<table id="dataTable">
    <thead>
    <tr>
        <th>用户id</th>
        <th>姓氏</th>
        <th>手机号码</th>
        <th>年龄</th>
        <th>性别</th>
        <th>民族</th>
        <th>婚姻状况</th>
        <th>证件区县</th>
        <th>开卡区县</th>
        <th>用户状态</th>
        <th>号码品牌</th>
        <th>用户类型</th>
        <th>所属区域</th>
        <th>付费类型</th>
        <th>星级</th>
        <th>是否当月新增</th>
    </tr>
    </thead>
    <tbody id="dataBody">
    <!-- 数据行将通过JavaScript动态生成 -->
    </tbody>
</table>

<!-- 分页控制 -->
<div id="pagination">
    <!-- 分页按钮将通过JavaScript动态生成 -->
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    // 提交数据函数
    function submitData() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) {
            alert('请选择一个文件！');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        fetch('http://127.0.0.1:8080/api/addBB', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())

            .then(data => {
                console.log(data)
                if (data.list1.length === 0) {
                    alert('所有数据都符合规则，无需下载。');
                    document.getElementById('downloadLink').style.display = 'none';
                } else {
                    generateExcel(data.list1, data.list2);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // 生成并下载Excel文件
    // function generateExcel(list1, list2) {
    //     const wb = XLSX.utils.book_new();
    //     const ws_data = [
    //         ["用户id", "姓氏", "手机号码", "年龄", "性别", "民族", "婚姻状况", "证件区县", "开卡区县", "用户状态", "号码品牌", "用户类型", "所属区域", "付费类型", "星级", "是否当月新增"]
    //     ];
    //
    //     console.log("list1",list1, "list2",list2)
    //
    //     list1.forEach((item, index) => {
    //         const row = [
    //             item.user_id, item.suename, item.phone_NUMBER, item.age, item.sex, item.nanl, item.mage_STATUS,
    //             item.idty_CNTY, item.open_CNTY, item.user_STATUS, item.msisdn_BRAND, item.user_TYPE,
    //             item.belo_AREA, item.pay_TYP, item.star, item.is_CM_NADD
    //         ];
    //
    //         // console.log(row)
    //         ws_data.push(row);
    //
    //         // 高亮不符合规则的字段
    //
    //         list2[index].forEach(fieldId => {
    //             ws_data[ws_data.length - 1][fieldId] = {
    //                 v: ws_data[ws_data.length - 1][fieldId],
    //                 s: { fill: { fgColor: { rgb: "FFFF00" } } }
    //             };
    //             // console.log('2222',fieldId,'ws',ws_data[ws_data.length - 1][fieldId]["v"])
    //
    //             // console.log(ws_data[ws_data.length - 1][fieldId]["v"])
    //         });
    //
    //
    //
    //     });
    //
    //     // console.log('wsdata',ws_data)
    //
    //     const ws = XLSX.utils.aoa_to_sheet(ws_data);
    //
    //     // console.log('ws',ws)
    //
    //     XLSX.utils.book_append_sheet(wb, ws, 'Invalid Data');
    //
    //     const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
    //     const blob = new Blob([wbout], {type: 'application/octet-stream'});
    //
    //     const downloadLink = document.getElementById('downloadLink');
    //     downloadLink.href = URL.createObjectURL(blob);
    //     downloadLink.style.display = 'block';
    // }



    // function generateExcel(list1, list2) {
    //     const wb = XLSX.utils.book_new();
    //     const ws_data = [
    //         ["用户id", "姓氏", "手机号码", "年龄", "性别", "民族", "婚姻状况", "证件区县", "开卡区县", "用户状态", "号码品牌", "用户类型", "所属区域", "付费类型", "星级", "是否当月新增"]
    //     ];
    //
    //     list1.forEach((item, index) => {
    //         const row = [
    //             item.user_id, item.suename, item.phone_NUMBER, item.age, item.sex, item.nanl, item.mage_STATUS,
    //             item.idty_CNTY, item.open_CNTY, item.user_STATUS, item.msisdn_BRAND, item.user_TYPE,
    //             item.belo_AREA, item.pay_TYP, item.star, item.is_CM_NADD
    //         ];
    //
    //         // 高亮不符合规则的字段
    //         list2[index].forEach(fieldId => {
    //             row[fieldId] = {v: row[fieldId], s: {fill: {fgColor: {rgb: "FFFF00"}}}};
    //         });
    //
    //         ws_data.push(row);
    //     });
    //
    //     const ws = XLSX.utils.aoa_to_sheet(ws_data);
    //
    //     // Apply cell styles manually (this step may not be necessary depending on your setup)
    //     list2.forEach((highlightedFields, rowIndex) => {
    //         highlightedFields.forEach(fieldId => {
    //             const cellAddress = XLSX.utils.encode_cell({r: rowIndex + 1, c: fieldId});
    //             if (!ws[cellAddress]) return;
    //             ws[cellAddress].s = {fill: {fgColor: {rgb: "FFFF00"}}};
    //         });
    //     });
    //
    //     XLSX.utils.book_append_sheet(wb, ws, 'Invalid Data');
    //
    //     const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
    //     const blob = new Blob([wbout], {type: 'application/octet-stream'});
    //
    //     const downloadLink = document.getElementById('downloadLink');
    //     downloadLink.href = URL.createObjectURL(blob);
    //     downloadLink.style.display = 'block';
    // }

    function generateExcel(list1, list2) {
        const wb = XLSX.utils.book_new();
        const ws_data = [
            ["用户id", "姓氏", "手机号码", "年龄", "性别", "民族", "婚姻状况", "证件区县", "开卡区县", "用户状态", "号码品牌", "用户类型", "所属区域", "付费类型", "星级", "是否当月新增"]
        ];

        list1.forEach((item, index) => {
            const row = [
                item.user_id, item.suename, item.phone_NUMBER, item.age, item.sex, item.nanl, item.mage_STATUS,
                item.idty_CNTY, item.open_CNTY, item.user_STATUS, item.msisdn_BRAND, item.user_TYPE,
                item.belo_AREA, item.pay_TYP, item.star, item.is_CM_NADD
                        ];

            // 将有问题的数据字体设置为红色
            list2[index].forEach(fieldId => {
                row[fieldId] = { v: row[fieldId], s: { font: { color: { rgb: "FF0000" } } } };
            });

            ws_data.push(row);
        });

        const ws = XLSX.utils.aoa_to_sheet(ws_data);

        // 手动应用红色字体样式
        list2.forEach((highlightedFields, rowIndex) => {
            highlightedFields.forEach(fieldId => {
                const cellAddress = XLSX.utils.encode_cell({r: rowIndex + 1, c: fieldId});
                if (!ws[cellAddress]) return;
                ws[cellAddress].s = { font: { color: { rgb: "FF0000" } } };
            });
        });

        XLSX.utils.book_append_sheet(wb, ws, 'Invalid Data');

        const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
        const blob = new Blob([wbout], {type: 'application/octet-stream'});

        const downloadLink = document.getElementById('downloadLink');
        downloadLink.href = URL.createObjectURL(blob);
        downloadLink.style.display = 'block';
    }



    // 分页展示函数
    function fetchPage(pageNumber) {
        fetch(`http://127.0.0.1:8080/api/getB?page=${pageNumber}&size=15`)
            .then(response => response.json())
            .then(data => {
                renderTable(data.items);
                renderPagination(data.totalPages, pageNumber);
            })
            .catch(error => console.error('Error:', error));
    }

    // 渲染表格数据
    function renderTable(data) {
        const dataBody = document.getElementById('dataBody');
        dataBody.innerHTML = '';

        data.forEach(item => {
            const row = `
                <tr>
                    <td>${item.user_id}</td>
                    <td>${item.suename}</td>
                    <td>${item.phone_number}</td>
                    <td>${item.age}</td>
                    <td>${item.sex}</td>
                    <td>${item.nanl}</td>
                    <td>${item.mage_status}</td>
                    <td>${item.idty_cnty}</td>
                    <td>${item.open_cnty}</td>
                    <td>${item.user_status}</td>
                    <td>${item.msisdn_brand}</td>
                    <td>${item.user_type}</td>
                    <td>${item.belo_area}</td>
                    <td>${item.pay_typ}</td>
                    <td>${item.star}</td>
                    <td>${item.is_cm_nadd}</td>
                </tr>
            `;
            dataBody.insertAdjacentHTML('beforeend', row);
        });
    }

    // 渲染分页控制
    function renderPagination(totalPages, currentPage) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.disabled = i === currentPage;
            button.addEventListener('click', () => fetchPage(i));
            pagination.appendChild(button);
        }
    }

    // 初始加载第一页数据
    fetchPage(1);
</script>

</body>
</html>
